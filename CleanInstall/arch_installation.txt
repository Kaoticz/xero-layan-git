#! /usr/env/bin bash

## 1. Installation

# Set keyboard layout
loadkeys br-abnt

# Update the system clock
timedatectl set-timezone America/Sao_Paulo
timedatectl set-ntp true

# Check the drives and its partitions
lsblk

# Check this https://wiki.archlinux.org/title/Advanced_Format

# Partition the disk - do these in order!
# Run "g" to make the disk GPT
# Now create a partition of size +512M with "n"
# Create a second partition takes everything else with "n" again
# Change the type of the first partition to "EF" or "1" (EFI System) with "t"
# Save and exit with "w"
fdisk /dev/sda

# Format the disk
mkfs.vfat /dev/sda1
mkfs.btrfs -L main_drive /dev/sda2 # Suggestion for the drive name: arch_ssdnvme

# Mount the disk and create Btrfs subvolumes
mount /dev/sda2 /mnt

btrfs su cr /mnt/@
btrfs su cr /mnt/@home

# Unmount the disk
umount /mnt

# Mount the partitions and their subvolumes
mount -o noatime,commit=120,compress=zstd,discard=async,space_cache=v2,subvol=@ /dev/sda2 /mnt

mount --mkdir /dev/sda1 /mnt/efi
mount --mkdir -o noatime,commit=120,compress=zstd,discard=async,space_cache=v2,subvol=@home /dev/sda2 /mnt/home

# Install the system
pacstrap -K /mnt base base-devel linux-zen linux-zen-headers linux-firmware intel-ucode amd-ucode btrfs-progs archlinux-keyring refind efibootmgr gptfdisk bash nano man-db tldr git #nvidia-dkms nvidia-utils lib32-nvidia-utils nvidia-settings

refind-install --root /mnt
nano /mnt/efi/EFI/refind/refind.conf
# ...
# timeout 3
# enable_mouse
# extra_kernel_version_strings linux-zen,linux-lts,linux-hardened,linux
# fold_linux_kernels false
# default_selection "+,bzImage,vmlinuz"
# ...

nano /mnt/boot/refind_linux.conf # https://wiki.archlinux.org/title/REFInd#refind_linux.conf
# ...
# If you're using the NVIDIA driver, also add:
# nvidia_drm.modeset=1
# This is needed to make Wayland work.
# ...
# Add this if you need to mitigate the MDS/SMT CPU vulnerabilities:
# Warning: it will decrease the performance of your CPU
# mds=full,nosmt
# ...
# "Boot using default options"      "root=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX rw add_efi_memmap zswap.enabled=0 rootflags=subvol=@ initrd=@\boot\intel-ucode.img initrd=@\boot\amd-ucode.img initrd=@\boot\initramfs-%v.img"
# "Boot using fallback initramfs"   "root=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX rw add_efi_memmap zswap.enabled=0 rootflags=subvol=@ initrd=@\boot\intel-ucode.img initrd=@\boot\amd-ucode.img initrd=@\boot\initramfs-%v-fallback.img"
# "Boot to terminal"                "root=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX rw add_efi_memmap zswap.enabled=0 rootflags=subvol=@ initrd=@\boot\intel-ucode.img initrd=@\boot\amd-ucode.img initrd=@\boot\initramfs-%v.img systemd.unit=multi-user.target"
# ...

# Use this if rEFInd is not able to detect the distro
#cp /mnt/boot/EFI/refind/icons/os_arch.png /mnt/boot/vmlinuz-linux-zen.png

# Enter the installed system
arch-chroot /mnt /bin/bash

# Set the default keyboard layout
loadkeys br-abnt
echo 'KEYMAP=br-abnt' >> /etc/vconsole.conf

# Fix Systemd's annoyingly long timeout
nano /etc/systemd/user.conf
# ...
# DefaultTimeoutStopSec=15s
# ...

# Change the default pacman settings
nano /etc/pacman.conf
# ...
# Color
# VerbosePkgLists
# ParallelDownloads = 7
# ILoveCandy
#
# [multilib]
# Include = /etc/pacman.d/mirrorlist
# ...

# Install the network manager
pacman --noconfirm --disable-download-timeout -Syu networkmanager
systemctl enable NetworkManager

# Set DNS provider to https://www.dns0.eu/open
nano /etc/NetworkManager/conf.d/dns-servers.conf
# ...
# [global-dns-domain-*]
# servers=193.110.81.254,185.253.5.254,2a0f:fc80::ffff,2a0f:fc81::ffff
# ...

# Set the time zone
ln -sf /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
hwclock --systohc

# Set the locale
echo 'LC_ALL=en_US.UTF-8' >> /etc/environment
echo 'LANG=en_US.UTF-8' >> /etc/locale.conf
echo 'en_US.UTF-8 UTF-8' >> /etc/locale.gen
locale-gen

# Set XDG variables
nano /etc/security/pam_env.conf
# ...
# # Base XDG
# XDG_CONFIG_HOME DEFAULT=@{HOME}/.config
# XDG_CACHE_HOME  DEFAULT=@{HOME}/.cache
# XDG_DATA_HOME   DEFAULT=@{HOME}/.local/share
# XDG_STATE_HOME  DEFAULT=@{HOME}/.local/state
# ...

# Set the hostname
echo 'phoenix' > /etc/hostname

# Set zram
pacman --noconfirm --disable-download-timeout -Syu zram-generator
nano /etc/systemd/zram-generator.conf
# ...
# [zram0]
# zram-size = ram / 4
# compression-algorithm = zstd
# fs-type = swap
# ...

nano /etc/sysctl.d/99-vm-zram-parameters.conf
# ...
# vm.swappiness = 180
# vm.watermark_boost_factor = 0
# vm.watermark_scale_factor = 125
# vm.page-cluster = 0
# ...

# Set the root password
passwd

# Add an admin user
useradd -mg wheel kotz
passwd kotz

# Define the permissions for sudo

nano /etc/sudoers
# ...
# # Give admin to all wheel users
# %wheel ALL=(ALL) ALL
#
# # Don't ask for root password in the same console session
# Defaults !tty_tickets
# ...

mkdir /etc/pacman.d/hooks
nano /etc/pacman.d/hooks/refind.hook
# ...
# [Trigger]
# Operation=Upgrade
# Type=Package
# Target=refind
#
# [Action]
# Description = Updating rEFInd on ESP
# When=PostTransaction
# Exec=/usr/bin/refind-install
# ...

# Set gnupg
pacman -Syu gnupg
nano /etc/pacman.d/gnupg/gpg-agent.conf
# ...
# #disable-scdaemon                         # Disables support for smart cards.
# #default-cache-ttl 600                    # Defines how long a passphrase remains cached in memory.
# #max-cache-ttl 43200                      # Defines the maximum value default-cache-ttl is allowed to have.
# pinentry-program /usr/bin/pinentry-gtk-2  # Makes it so gnupg can ask for passwords in a GUI.
# ...

# Do this ONLY if you're installing in a VM. Pick whichever most appropriate.
# Otherwise, skip this section!

## Spice
pacman -Syu spice-vdagent

## VirtualBox
pacman -Syu virtualbox-guest-utils
systemctl enable vboxservice

# Exit the installed system
exit

# Generate the filesystem table file
genfstab -U /mnt > /mnt/etc/fstab   # Remove "subvolid" from all entries, if there are any

# Unmount the disk
umount -R /mnt

# Reboot
reboot


## 2. Log in as a user

# Check if zram is working (should return an output)
zramctl

# Install paru
git clone https://aur.archlinux.org/paru-bin.git
cd paru-bin
makepkg -si
paru --disable-download-timeout --asdeps -Syu bat devtools bash-completion gtk2
cd ..
rm -rf paru-bin

## Choose either 2.1 or 2.2
## Timeshift is generally easier to use.

# 2.1 Set up Timeshift
paru --disable-download-timeout -Syu timeshift
sudo systemctl enable cronie

# 2.2 Set up Snapper
paru --disable-download-timeout -Syu snapper btrfs-assistant refind-btrfs
snapper -c root_config create-config /
snapper -c home_config create-config /home

# Stop here if you do not want to use KDE Plasma as your desktop environment.

# 2.3 Install KDE Plasma
paru --disable-download-timeout -Syu xorg sddm plasma pipewire wireplumber pipewire-pulse pipewire-alsa  rate-mirrors-bin

# Update mirror list
rate-mirrors --allow-root arch | sudo tee /etc/pacman.d/mirrorlist

# Setup login manager to run on startup
sudo systemctl enable sddm

# (Optional) Install desktop applications
paru --disable-download-timeout -Syu packagekit-qt5 flatpak fwupd helvum easyeffects ark dolphin dolphin-plugins ffmpegthumbs filelight gwenview kalarm kate kcachegrind kcharselect kcolorchooser kcron kdegraphics-thumbnailers kdialog kio-extras kio-gdrive kio-zeroconf kjournald kolourpaint konsole ktorrent kwallet kwalletmanager okular spectacle yakuake


# 3. Enable suspension with Nvidia GPUs on Wayland.

echo 'options nvidia NVreg_PreserveVideoMemoryAllocations=1' | sudo tee -a /etc/modprobe.d/nvidia.conf

## The video buffer is saved to /tmp by default.
## To save the video buffer to disk instead, add the following option:
#echo 'options nvidia NVreg_TemporaryFilePath=/var/tmp' | sudo tee -a /etc/modprobe.d/nvidia.conf

sudo systemctl enable nvidia-suspend.service
sudo systemctl enable nvidia-hibernate.service
sudo systemctl enable nvidia-resume.service
sudo mkinitcpio -P

reboot

# 3. (Optional) Setup Layan theme for KDE Plasma | IGNORE THIS, DOESN'T WORK ANYMORE

paru -Syu lf eza awk expac ripgrep latte-dock kvantum neofetch nerd-fonts-meta ttf-symbola noto-fonts-cjk noto-fonts-emoji ttf-twemoji

# Go to Plasma's global themes and install the Layan theme from there.
# Then move in the configuration files from https://github.com/Kaoticz/xero-layan-git/tree/arch/Configs
