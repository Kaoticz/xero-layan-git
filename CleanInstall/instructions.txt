#!/bin/bash

# Setup keyboard layout
# localectl list-keymaps
# loadkeys br-abnt

# Setup system clock
timedatectl set-timezone America/Sao_Paulo
timedatectl set-ntp true

# Setup disk partitions
cfdisk /dev/sda
cfdisk /dev/sdb

# sda1 - 128M for boot partition, primary
# sda2 - root, primary
# sdb1 - /home, primary
# sdb2 - /var, primary

# Write the filesystem by formatting the drives
mkfs.ext4 /dev/sda1
mkfs.ext4 /dev/sda2
mkfs.ext4 /dev/sdb1

# Mount the root partition. This must come first!
mount /dev/sda2 /mnt

# Mount everything else
# Create the boot directory
mkdir /mnt/boot

# Create the directories for the stuff to be
# mounted on the secondary drive
mkdir /mnt/home
mkdir /mnt/var

# Mount the boot directory
mount /dev/sda1 /mnt/boot

# Mount the other directories
mount /dev/sdb1 /mnt/home
mount /dev/sdb1 /mnt/var

# Install the operational system
## Pick one of the following

## Regular Kernel
pacstrap /mnt base base-devel linux linux-firmware nvidia bash nano

## Or
## LTS Kernel
pacstrap /mnt base base-devel linux-lts linux-firmware nvidia-lts bash nano

# Create the fstab file
genfstab -U /mnt >> /mnt/etc/fstab

# Log into the installed system
arch-chroot /mnt /bin/bash

# Setup keyboard layout
loadkeys br-abnt

# Run the following
curl -OL https://raw.githubusercontent.com/Kaoticz/xero-layan-git/arch/CleanInstall/install1.sh
bash install1.sh

# Exit the local system
exit

# Unmount everything
umount -R /mnt

# Reboot the system
reboot

# Run the following
curl -OL https://raw.githubusercontent.com/Kaoticz/xero-layan-git/arch/CleanInstall/install2.sh
bash install2.sh

# Follow the instructions. Computer will reboot at the end.
## ILoveCandy under "VerbosePkgLists" to enable pacman-like progress bars
## ParallelDownloads to enable parallel downloads

# Open the terminal and run the script in the user home directory
# If it's not there, curl -OL https://raw.githubusercontent.com/Kaoticz/xero-layan-git/arch/CleanInstall/install3.sh
bash install3.sh

# Follow the instructions. Computer will reboot at the end.

# Setup swap file
## Create the swap file (2GB)
sudo dd if=/dev/zero of=/var/swapfile bs=1024 count=1953125â€¬

# Don't do this, causes problems on Btrfs drives
#sudo fallocate -l 2G /var/swapfile

sudo chmod 600 /var/swapfile

sudo mkswap /var/swapfile

sudo swapon /var/swapfile

echo "" | sudo tee -a /etc/fstab
echo "# Swap file" | sudo tee -a /etc/fstab
echo "/var/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab
# Done