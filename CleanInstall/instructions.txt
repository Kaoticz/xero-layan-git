#!/bin/bash

# Setup keyboard layout
# localectl list-keymaps
loadkeys br-abnt

# Setup system clock
timedatectl set-timezone America/Sao_Paulo
timedatectl set-ntp true

# Setup disk partitions
cfdisk /dev/sda
cfdisk /dev/sdb

# sda1 - 128M for boot partition, primary
# sda2 - root, primary
# sdb1 - [SWAP], primary
# sdb2 - /home, /var, primary

# Write the filesystem by formatting the drives
## FAT32
mkfs.fat -F32 /dev/sda1
## BTRFS
mkfs.btrfs -d single /dev/sda2 /dev/sdb2
## SWAP
mkswap /dev/sdb1
swapon /dev/sdb1

# Mount the root partition directly. This must come first!
mount /dev/sda2 /mnt

# Create the btrfs subvolumes
btrfs su cr /mnt/@
btrfs su cr /mnt/@home
btrfs su cr /mnt/@var
btrfs su cr /mnt/@data

# Unmount root
umount /mnt

# Mount root through the btrfs subvolume
## space_cache might cause issues
mount -o noatime,commit=120,compress=zstd,discard=async,space_cache,subvol=@ /dev/sda2 /mnt

# Mount everything else
# Create the boot directory
mkdir /mnt/boot

# Create the directories for the stuff to be
# mounted on the secondary drive
mkdir /mnt/home
mkdir /mnt/var
mkdir /mnt/data

# Mount the boot directory
mount /dev/sda1 /mnt/boot

# Mount the other directories
mount -o noatime,commit=120,compress=zstd,space_cache,subvol=@home /dev/sdb2 /mnt/home
mount -o noatime,commit=120,compress=zstd,space_cache,subvol=@var /dev/sdb2 /mnt/var
mount -o noatime,commit=120,compress=zstd,space_cache,subvol=@data /dev/sdb2 /mnt/data

# Install the operational system
# Replace intel-ucode with amd-ucode if you have an AMD CPU
## Pick one of the following

## Regular Kernel
pacstrap /mnt base base-devel linux linux-lts linux-firmware intel-ucode btrfs-progs nvidia nvidia-lts bash nano

# Create the fstab file
genfstab -U /mnt >> /mnt/etc/fstab

# Log into the installed system
arch-chroot /mnt /bin/bash

# Setup keyboard layout
loadkeys br-abnt

# Run the following
curl -OL https://raw.githubusercontent.com/Kaoticz/xero-layan-git/arch/CleanInstall/install1.sh
bash install1.sh

# Exit the local system
exit

# Unmount everything
umount -R /mnt

# Reboot the system
reboot

# Run the following
## Check list at the end for the suggested KDE applications
curl -OL https://raw.githubusercontent.com/Kaoticz/xero-layan-git/arch/CleanInstall/install2.sh
bash install2.sh

# Follow the instructions. Computer will reboot at the end.
## ILoveCandy under "VerbosePkgLists" to enable pacman-like progress bars
## ParallelDownloads to enable parallel downloads

# Open the terminal and run the script in the user home directory
# If it's not there, curl -OL https://raw.githubusercontent.com/Kaoticz/xero-layan-git/arch/CleanInstall/install3.sh
bash install3.sh

# Follow the instructions. Computer will reboot at the end.

# Setup swap file - DO NOT do this if a swap partition was set up
## Create the swap file (2GB)
sudo dd if=/dev/zero of=/var/swapfile bs=1024 count=1953125â€¬

# Don't do this, causes problems on Btrfs drives
#sudo fallocate -l 2G /var/swapfile

sudo chmod 600 /var/swapfile

sudo mkswap /var/swapfile

sudo swapon /var/swapfile

echo "" | sudo tee -a /etc/fstab
echo "# Swap file" | sudo tee -a /etc/fstab
echo "/var/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab
# Done




###### List of KDE applications to install ######
# 5 - ark
# 13 - dolphin
# 17 - ffmpegthumbs
# 18 - filelight
# 21 - gwenview
# 37 - kbackup
# 43 - kcachegrind
# 45 - kcharselect
# 46 - kcolorchooser
# 47 - kcron
# 52 - kdegraphics-mobipocket
# 53 - kdegraphics-thumbnailers
# 60 - kdialog
# 63 - kfind
# 69 - kgpg
# 71 - khelpcenter
# 76 - kio-extras
# 77 - kio-gdrive
# 89 - kmail
# 102 - kolourpaint
# 103 - kompare
# 106 - konsole
# 111 - korganizer
# 124 - ksystemlog
# 126 - ktimer
# 127 - ktorrent
# 135 - kwrite
# 136 - lokalize
# 139 - markdownpart
# 142 - okular
# 154 - spectacle
# 156 - svgpart
# 157 - sweeper
# 170 - umbrello
# 172 - zeroconf-ioslave